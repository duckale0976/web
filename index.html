<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinhducKale - Nền tảng Y Khoa Tổng Hợp</title>
    <meta name="description" content="Nền tảng học tập, tra cứu thuốc và công cụ y khoa dành cho sinh viên Y.">
    <meta name="author" content="Đào Minh Đức">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #007bb5; /* Medical Blue */
            --secondary-color: #00a896; /* Teal */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #dddddd;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --header-height: 60px;
        }

        [data-theme="dark"] {
            --primary-color: #4db6ac;
            --secondary-color: #26a69a;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; transition: background 0.3s; }

        /* Helpers */
        .hidden { display: none !important; }
        .btn-primary, .btn-secondary { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: opacity 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }
        .full-width { width: 100%; margin-top: 10px; }

        /* Header */
        .app-header { height: var(--header-height); background-color: var(--card-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .logo-area h1 { font-size: 1.2rem; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .main-nav { display: flex; gap: 5px; }
        .main-nav .nav-btn { background: none; border: none; padding: 10px 15px; color: var(--text-muted); cursor: pointer; font-size: 0.95rem; border-radius: 4px; }
        .main-nav .nav-btn.active, .main-nav .nav-btn:hover { color: var(--primary-color); background: rgba(0,0,0,0.05); font-weight: bold; }
        .user-area { display: flex; align-items: center; gap: 10px; }
        #user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
        #theme-toggle { background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.1rem; padding: 5px; }

        /* Main */
        .app-content { flex: 1; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Hero */
        .hero { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cta-group { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .info-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .text-link { color: var(--primary-color); text-decoration: none; font-weight: 500; }

        /* Grids & Lists */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .controls input, .controls select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color); }
        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .doc-item, .drug-item { background: var(--card-bg); padding: 15px; border-radius: 6px; border-left: 4px solid var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .doc-item:hover, .drug-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .doc-meta { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; display: block; }
        .drug-detail { font-size: 0.9rem; margin-top: 8px; border-top: 1px solid var(--border-color); padding-top: 8px; }

        /* Notes */
        .note-editor-container { height: 60vh; position: relative; }
        #personal-note { width: 100%; height: 100%; padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color); resize: none; font-size: 1rem; line-height: 1.6; outline: none; }
        .status-text { font-size: 0.8rem; color: var(--text-muted); font-style: italic; margin-right: 10px; }

        /* Chat */
        .chat-container { height: 70vh; display: flex; flex-direction: column; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; position: relative; }
        .message.mine { align-self: flex-end; background-color: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .message.theirs { align-self: flex-start; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 0.7rem; opacity: 0.8; margin-bottom: 4px; display: block; font-weight: bold; }
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; background: var(--card-bg); }
        #chat-input { flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 25px; background: var(--bg-color); color: var(--text-color); outline: none; }

        /* Tools */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .tool-card { background: var(--card-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; }
        .tool-card h3 { margin-bottom: 15px; color: var(--primary-color); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color); }
        .result-box { margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px; font-weight: bold; color: var(--primary-color); min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .timer-display { font-size: 3.5rem; margin: 20px 0; font-family: monospace; color: var(--text-color); }
        .timer-controls { display: flex; justify-content: center; gap: 10px; }

        /* Footer */
        .app-footer { background-color: #2c3e50; color: #ecf0f1; padding: 40px 20px 20px; margin-top: 40px; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 30px; max-width: 1200px; margin: 0 auto; }
        .footer-info h4 { margin-bottom: 10px; color: #3498db; }
        .footer-info a, .footer-links a { color: #bdc3c7; text-decoration: none; transition: color 0.2s; }
        .footer-info a:hover, .footer-links a:hover { color: white; }
        .copyright { text-align: center; margin-top: 30px; font-size: 0.8rem; border-top: 1px solid #34495e; padding-top: 15px; color: #7f8c8d; }

        /* Modal & Toast */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal { background: var(--card-bg); width: 90%; max-width: 500px; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
        .modal-header { padding: 15px 20px; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-header button { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: right; }
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 5px; background: var(--bg-color); color: var(--text-color); }

        /* Responsive */
        @media (max-width: 768px) {
            .main-nav span { display: none; }
            .app-header { padding: 0 10px; }
            .chat-container { height: 85vh; }
            .tools-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-area">
            <h1><i class="fa-solid fa-staff-snake"></i> MinhducKale</h1>
        </div>
        <nav class="main-nav">
            <button class="nav-btn active" data-target="home"><i class="fa-solid fa-home"></i> <span>Trang chủ</span></button>
            <button class="nav-btn" data-target="docs"><i class="fa-solid fa-book-medical"></i> <span>Tài liệu</span></button>
            <button class="nav-btn" data-target="drugs"><i class="fa-solid fa-pills"></i> <span>Thuốc</span></button>
            <button class="nav-btn" data-target="notes"><i class="fa-solid fa-notes-medical"></i> <span>Ghi chú</span></button>
            <button class="nav-btn" data-target="chat"><i class="fa-solid fa-comments"></i> <span>Thảo luận</span></button>
            <button class="nav-btn" data-target="tools"><i class="fa-solid fa-calculator"></i> <span>Công cụ</span></button>
        </nav>
        <div class="user-area">
            <button id="theme-toggle" title="Chế độ Sáng/Tối"><i class="fa-solid fa-moon"></i></button>
            <div id="auth-container">
                <button id="login-btn" class="btn-primary">Đăng nhập</button>
                <div id="user-info" class="hidden">
                    <img id="user-avatar" src="" alt="Avatar">
                    <span id="user-name" style="font-size: 0.9rem; font-weight: 500;">Guest</span>
                    <button id="logout-btn" style="background:none; border:none; color: var(--danger-color); cursor: pointer; margin-left: 5px;"><i class="fa-solid fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </header>

    <main class="app-content">
        
        <section id="home" class="view active">
            <div class="hero">
                <h2>Chào mừng đến với MinhducKale</h2>
                <p>Nền tảng hỗ trợ học tập và thực hành lâm sàng cho sinh viên Y khoa.</p>
                <div class="cta-group">
                    <button class="btn-primary" onclick="switchView('docs')">Tìm tài liệu</button>
                    <button class="btn-secondary" onclick="switchView('tools')">Công cụ Y khoa</button>
                </div>
            </div>
            <div class="info-cards">
                <div class="card">
                    <h3><i class="fa-solid fa-link"></i> Nguồn Tài Liệu</h3>
                    <p>Truy cập kho tài liệu tổng hợp từ Google Drive.</p>
                    <a href="https://drive.google.com/drive/u/2/folders/1GnW2tjMYi-FcmEstNQQu8WD25AK06W9-" target="_blank" class="text-link">Mở Drive Tổng &rarr;</a>
                </div>
                <div class="card">
                    <h3><i class="fa-solid fa-user-md"></i> Thông tin liên hệ</h3>
                    <p>Chủ sở hữu: <strong>Đào Minh Đức</strong></p>
                    <p>SĐT: 0976969072</p>
                </div>
            </div>
        </section>

        <section id="docs" class="view">
            <div class="section-header">
                <h2>Kho Tài Liệu</h2>
                <div class="controls">
                    <input type="text" id="docs-search" placeholder="Tìm kiếm tài liệu...">
                    <select id="docs-filter">
                        <option value="all">Tất cả chuyên khoa</option>
                        <option value="Nội">Nội khoa</option>
                        <option value="Ngoại">Ngoại khoa</option>
                        <option value="Sản">Sản phụ khoa</option>
                        <option value="Nhi">Nhi khoa</option>
                    </select>
                    <button id="add-doc-btn" class="btn-primary admin-only hidden"><i class="fa-solid fa-plus"></i> Thêm</button>
                </div>
            </div>
            <div id="docs-list" class="grid-list">
                </div>
        </section>

        <section id="drugs" class="view">
            <div class="section-header">
                <h2>Tra Cứu Thuốc</h2>
                <div class="controls">
                    <input type="text" id="drugs-search" placeholder="Nhập tên thuốc/hoạt chất...">
                    <button id="add-drug-btn" class="btn-primary admin-only hidden"><i class="fa-solid fa-plus"></i> Thêm</button>
                </div>
            </div>
            <div id="drugs-result" class="list-view">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                    <i class="fa-solid fa-magnifying-glass" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Nhập từ khóa để bắt đầu tra cứu...</p>
                </div>
            </div>
        </section>

        <section id="notes" class="view">
            <div class="section-header">
                <h2>Ghi Chú Cá Nhân</h2>
                <div class="controls">
                    <span id="save-status" class="status-text">Đã đồng bộ</span>
                    <button id="export-note-btn" class="btn-secondary"><i class="fa-solid fa-file-export"></i> Xuất .txt</button>
                </div>
            </div>
            <div class="note-editor-container">
                <textarea id="personal-note" placeholder="Viết ghi chú lâm sàng của bạn tại đây... (Yêu cầu đăng nhập để lưu)"></textarea>
            </div>
        </section>

        <section id="chat" class="view">
            <div class="chat-container">
                <div class="chat-header">
                    <div><i class="fa-solid fa-comments"></i> Thảo luận Lâm sàng</div>
                    <span style="font-size: 0.8rem; font-weight: normal; background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px;">Live</span>
                </div>
                <div id="chat-messages" class="chat-messages">
                    </div>
                <form id="chat-form" class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Nhập tin nhắn..." autocomplete="off" maxlength="500">
                    <button type="submit" class="btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </section>

        <section id="tools" class="view">
            <div class="tools-grid">
                <div class="tool-card">
                    <h3>BMI Calculator</h3>
                    <div class="input-group">
                        <label>Cân nặng (kg)</label>
                        <input type="number" id="bmi-weight" placeholder="VD: 60">
                    </div>
                    <div class="input-group">
                        <label>Chiều cao (cm)</label>
                        <input type="number" id="bmi-height" placeholder="VD: 170">
                    </div>
                    <button id="calc-bmi-btn" class="btn-primary full-width">Tính toán</button>
                    <div id="bmi-result" class="result-box">Kết quả</div>
                </div>

                <div class="tool-card">
                    <h3>Máy tính Y khoa</h3>
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Hỗ trợ +, -, *, /, ( ).</p>
                    <div class="input-group">
                        <input type="text" id="calc-input" placeholder="Ví dụ: (50 * 10) / 2">
                    </div>
                    <button id="calc-exec-btn" class="btn-primary full-width">Tính</button>
                    <div id="calc-result" class="result-box">0</div>
                </div>

                <div class="tool-card">
                    <h3>Timer Học tập</h3>
                    <div class="timer-display" id="timer-display">25:00</div>
                    <div class="timer-controls">
                        <button id="timer-start" class="btn-primary">Start/Stop</button>
                        <button id="timer-reset" class="btn-secondary">Reset</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Tiêu đề</h3>
                <button id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button id="modal-action-btn" class="btn-primary">Lưu</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-info">
                <h4>MinhducKale</h4>
                <p>Chủ sở hữu: <strong>Đào Minh Đức</strong></p>
                <p>SĐT: <a href="tel:0976969072">0976969072</a></p>
                <p>
                    <a href="https://duckale0976.github.io/web/" target="_blank">Website chính</a> | 
                    <a href="#" onclick="alert('Xem README để biết danh sách nguồn')">Nguồn tham khảo y khoa</a>
                </p>
            </div>
            <div class="footer-links">
                <a href="https://drive.google.com/drive/u/2/folders/1GnW2tjMYi-FcmEstNQQu8WD25AK06W9-" target="_blank">
                    <i class="fa-brands fa-google-drive"></i> Kho Tài Liệu Tổng
                </a>
            </div>
        </div>
        <div class="copyright">
            &copy; 2025 MinhducKale. Medical Education Platform.
        </div>
    </footer>

    <script type="module">
        // Import Firebase SDKs from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, doc, query, where, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION (THAY API KEY CỦA BẠN VÀO ĐÂY)
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        // Lưu ý: Nếu chưa thay config, app sẽ lỗi khi gọi DB.
        let app, auth, db, googleProvider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            googleProvider = new GoogleAuthProvider();
            console.log("Firebase Initialized");
        } catch (e) {
            console.error("Firebase Init Error (Kiểm tra Config):", e);
        }

        // Global State
        let currentUser = null;
        let isAdmin = false;

        // ==========================================
        // UI HELPERS
        // ==========================================
        
        // Navigation Logic
        const navBtns = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        
        window.switchView = (targetId) => {
            navBtns.forEach(b => {
                b.classList.remove('active');
                if(b.getAttribute('data-target') === targetId) b.classList.add('active');
            });
            views.forEach(v => {
                v.classList.remove('active');
                if(v.id === targetId) v.classList.add('active');
            });
        };

        navBtns.forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.getAttribute('data-target')));
        });

        // Theme Toggle
        const themeBtn = document.getElementById('theme-toggle');
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
        }
        themeBtn.addEventListener('click', () => {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                themeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
            }
        });

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.innerText = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '4px';
            toast.style.color = '#fff';
            toast.style.zIndex = '9999';
            toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            
            if (type === 'success') toast.style.background = '#5cb85c';
            else if (type === 'error') toast.style.background = '#d9534f';
            else toast.style.background = '#007bb5';

            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Modal Helper
        function openModal(title, bodyHtml, onSave) {
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            
            const saveBtn = document.getElementById('modal-action-btn');
            const newBtn = saveBtn.cloneNode(true); // Remove old listeners
            saveBtn.parentNode.replaceChild(newBtn, saveBtn);
            
            newBtn.addEventListener('click', () => {
                if(onSave) onSave();
                overlay.classList.add('hidden');
            });
            
            overlay.classList.remove('hidden');
            document.getElementById('modal-close').onclick = () => overlay.classList.add('hidden');
        }

        // Debounce
        function debounce(func, timeout = 300){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');

        loginBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
                showToast('Đăng nhập thành công', 'success');
            } catch (error) {
                console.error(error);
                showToast('Lỗi đăng nhập: ' + error.message, 'error');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showToast('Đã đăng xuất');
        });

        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    loginBtn.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                    document.getElementById('user-avatar').src = user.photoURL || 'https://via.placeholder.com/32';
                    document.getElementById('user-name').innerText = user.displayName;
                    
                    // Check Admin (Simulated check, real check is in Rules)
                    // Ở đây bạn có thể check role từ Firestore nếu muốn
                    const idToken = await user.getIdTokenResult();
                    if(idToken.claims.admin) isAdmin = true;
                } else {
                    loginBtn.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                    isAdmin = false;
                }
                
                // Toggle Admin Buttons
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.toggle('hidden', !isAdmin);
                });

                // Reload notes if user changes
                loadNote();
            });
        }

        // ==========================================
        // FEATURES
        // ==========================================

        /* --- DOCS SYSTEM --- */
        async function loadDocs(search = '', cat = 'all') {
            const listEl = document.getElementById('docs-list');
            listEl.innerHTML = '<p>Đang tải...</p>';
            try {
                // In prod: use compound queries. Here: fetch all & filter (small scale)
                const snapshot = await getDocs(collection(db, 'docs'));
                let docs = [];
                snapshot.forEach(d => docs.push({id: d.id, ...d.data()}));

                if (cat !== 'all') docs = docs.filter(d => d.category === cat);
                if (search) docs = docs.filter(d => d.title.toLowerCase().includes(search.toLowerCase()));

                listEl.innerHTML = '';
                if(docs.length === 0) {
                    listEl.innerHTML = '<p>Không tìm thấy tài liệu.</p>';
                    return;
                }

                docs.forEach(doc => {
                    const div = document.createElement('div');
                    div.className = 'doc-item';
                    div.innerHTML = `
                        <h4>${doc.title}</h4>
                        <span class="doc-meta"><i class="fa-solid fa-tag"></i> ${doc.category}</span>
                        <p>${doc.desc || ''}</p>
                        <a href="${doc.link}" target="_blank" class="text-link">Xem tài liệu <i class="fa-solid fa-external-link-alt"></i></a>
                    `;
                    listEl.appendChild(div);
                });
            } catch (e) {
                console.warn(e);
                listEl.innerHTML = '<p>Chưa kết nối Database hoặc lỗi.</p>';
            }
        }

        document.getElementById('add-doc-btn').addEventListener('click', () => {
            const formHtml = `
                <div class="form-group"><label>Tiêu đề</label><input id="d-title"></div>
                <div class="form-group"><label>Chuyên khoa</label>
                    <select id="d-cat"><option value="Nội">Nội</option><option value="Ngoại">Ngoại</option><option value="Sản">Sản</option><option value="Nhi">Nhi</option></select>
                </div>
                <div class="form-group"><label>Link</label><input id="d-link"></div>
                <div class="form-group"><label>Mô tả</label><textarea id="d-desc"></textarea></div>
            `;
            openModal('Thêm tài liệu', formHtml, async () => {
                const title = document.getElementById('d-title').value;
                const category = document.getElementById('d-cat').value;
                const link = document.getElementById('d-link').value;
                const desc = document.getElementById('d-desc').value;
                if(!title) return;
                try {
                    await addDoc(collection(db, 'docs'), { title, category, link, desc, createdAt: new Date() });
                    showToast('Đã thêm');
                    loadDocs();
                } catch(e) { showToast('Lỗi (Quyền Admin?)', 'error'); }
            });
        });

        // Search Listeners
        document.getElementById('docs-search').addEventListener('input', debounce((e) => loadDocs(e.target.value, document.getElementById('docs-filter').value)));
        document.getElementById('docs-filter').addEventListener('change', (e) => loadDocs(document.getElementById('docs-search').value, e.target.value));

        /* --- DRUGS SYSTEM --- */
        async function searchDrugs(term) {
            const resEl = document.getElementById('drugs-result');
            if(!term) return;
            resEl.innerHTML = 'Đang tìm...';
            
            try {
                // Simplified client-side filter
                const snapshot = await getDocs(query(collection(db, 'drugs'), limit(50)));
                const res = [];
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.name.toLowerCase().includes(term.toLowerCase()) || data.activeIngredient?.toLowerCase().includes(term.toLowerCase()))
                        res.push(data);
                });
                
                resEl.innerHTML = '';
                if(res.length === 0) resEl.innerHTML = 'Không tìm thấy thuốc.';
                
                res.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'drug-item';
                    div.innerHTML = `<h4>${d.name} <small>(${d.activeIngredient})</small></h4>
                        <div class="drug-detail"><strong>Liều:</strong> ${d.dosage}</div>
                        <div class="drug-detail"><strong>Chống chỉ định:</strong> ${d.contra}</div>`;
                    resEl.appendChild(div);
                });
            } catch(e) { resEl.innerHTML = 'Lỗi kết nối.'; }
        }

        document.getElementById('drugs-search').addEventListener('input', debounce(e => searchDrugs(e.target.value)));
        document.getElementById('add-drug-btn').addEventListener('click', () => {
            const html = `<div class="form-group"><label>Tên</label><input id="dr-name"></div>
                          <div class="form-group"><label>Hoạt chất</label><input id="dr-active"></div>
                          <div class="form-group"><label>Liều</label><input id="dr-dose"></div>
                          <div class="form-group"><label>CCĐ</label><input id="dr-contra"></div>`;
            openModal('Thêm thuốc', html, async () => {
                try {
                    await addDoc(collection(db, 'drugs'), {
                        name: document.getElementById('dr-name').value,
                        activeIngredient: document.getElementById('dr-active').value,
                        dosage: document.getElementById('dr-dose').value,
                        contra: document.getElementById('dr-contra').value
                    });
                    showToast('Đã thêm');
                } catch(e) { showToast('Lỗi', 'error'); }
            });
        });

        /* --- NOTES SYSTEM --- */
        const noteArea = document.getElementById('personal-note');
        const saveStatus = document.getElementById('save-status');
        
        async function loadNote() {
            if(!currentUser) {
                noteArea.value = '';
                noteArea.disabled = true;
                noteArea.placeholder = "Đăng nhập để sử dụng ghi chú.";
                return;
            }
            noteArea.disabled = false;
            noteArea.placeholder = "Ghi chú của bạn...";
            try {
                const snap = await getDoc(doc(db, 'users', currentUser.uid, 'notes', 'personal'));
                if(snap.exists()) noteArea.value = snap.data().content || '';
            } catch(e) {}
        }

        const saveNote = debounce(async (val) => {
            if(!currentUser) return;
            saveStatus.innerText = 'Đang lưu...';
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'notes', 'personal'), { content: val }, { merge: true });
                saveStatus.innerText = 'Đã lưu';
            } catch(e) { saveStatus.innerText = 'Lỗi lưu'; }
        }, 1000);

        noteArea.addEventListener('input', e => {
            saveStatus.innerText = 'Chưa lưu...';
            saveNote(e.target.value);
        });

        document.getElementById('export-note-btn').addEventListener('click', () => {
            const blob = new Blob([noteArea.value], {type: "text/plain"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "MinhducKale_Note.txt";
            a.click();
        });

        /* --- CHAT SYSTEM --- */
        const chatMsg = document.getElementById('chat-messages');
        function initChat() {
            const q = query(collection(db, 'chat'), orderBy('timestamp', 'asc'), limit(50));
            onSnapshot(q, (snap) => {
                chatMsg.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isMine = currentUser && data.uid === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `message ${isMine ? 'mine' : 'theirs'}`;
                    div.innerHTML = `<span class="msg-meta">${data.displayName}</span>${data.text.replace(/</g, "&lt;")}`;
                    chatMsg.appendChild(div);
                });
                chatMsg.scrollTop = chatMsg.scrollHeight;
            });
        }
        
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !currentUser) return;
            try {
                await addDoc(collection(db, 'chat'), {
                    text: txt, uid: currentUser.uid, displayName: currentUser.displayName, timestamp: serverTimestamp()
                });
                input.value = '';
            } catch(e) { showToast('Lỗi gửi', 'error'); }
        });

        /* --- TOOLS --- */
        // BMI
        document.getElementById('calc-bmi-btn').addEventListener('click', () => {
            const w = parseFloat(document.getElementById('bmi-weight').value);
            const h = parseFloat(document.getElementById('bmi-height').value) / 100;
            if(w && h) {
                const bmi = (w/(h*h)).toFixed(1);
                document.getElementById('bmi-result').innerText = `BMI: ${bmi}`;
            }
        });

        // Calc
        document.getElementById('calc-exec-btn').addEventListener('click', () => {
            try {
                const val = document.getElementById('calc-input').value;
                if(/[^0-9+\-*/().\s]/.test(val)) throw new Error();
                const res = new Function('return ' + val)();
                document.getElementById('calc-result').innerText = res;
            } catch(e) { document.getElementById('calc-result').innerText = 'Lỗi'; }
        });

        // Timer
        let timerInt;
        let timeLeft = 1500;
        let running = false;
        document.getElementById('timer-start').addEventListener('click', () => {
            if(running) { clearInterval(timerInt); running = false; return; }
            running = true;
            timerInt = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60);
                const s = timeLeft%60;
                document.getElementById('timer-display').innerText = `${m}:${s<10?'0'+s:s}`;
                if(timeLeft<=0) clearInterval(timerInt);
            }, 1000);
        });
        document.getElementById('timer-reset').addEventListener('click', () => {
            clearInterval(timerInt); running = false; timeLeft = 1500;
            document.getElementById('timer-display').innerText = "25:00";
        });

        // Init
        loadDocs();
        initChat();

    </script>
</body>
</html>
