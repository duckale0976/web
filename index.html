<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinhducKale v10 - Christmas Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <style>
        /* CORE STYLES (Retained v9/v8) */
        body { transition: background-color 0.5s, color 0.5s; background-color: #f7f7f7; color: #1e293b; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        .bg-blob { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.8; z-index: -1; animation: blob 20s infinite alternate; pointer-events: none; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #ef4444; } 
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #10b981; animation-delay: 5s; } 
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #60a5fa; animation-delay: 10s; } 
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.7); position: relative; }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.6); transition: all 0.3s ease; }
        .dark .glass-card { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(255, 255, 255, 0.05); }
        .admin-glow { box-shadow: 0 0 10px rgba(239, 68, 68, 0.7); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0%, 100% {box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.7);} 50% {box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.0);} }
        #snow-container { pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        .snowflake { position: absolute; top: -10px; color: #ffffff; opacity: 0.8; font-size: 12px; }
        .msg-bubble-me { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 18px 18px 0 18px; }
        .msg-bubble-other { background: #e2e8f0; color: #1e293b; border-radius: 18px 18px 18px 0; }
        .dark .msg-bubble-other { background: #334155; color: white; }
        .draggable-window { position: fixed; z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .window-header { cursor: move; user-select: none; }
        .ios-input { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(203, 213, 225, 0.8); color: #0f172a; font-weight: 600; }
        .dark .ios-input { background: rgba(0, 0, 0, 0.5); color: white; }
    </style>
</head>
<body onload="startSnow()">

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>
    
    <div id="snow-container"></div>

    <div id="loginOverlay" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-md flex items-center justify-center">
        <div class="glass-card p-8 rounded-3xl w-[90%] max-w-sm text-center">
            <div class="w-16 h-16 bg-red-600 rounded-2xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-lg shadow-red-500/50">
                <i class="fa-solid fa-tree"></i>
            </div>
            <h2 class="text-2xl font-extrabold mb-4 dark:text-white" id="loginStatusText">Đang kiểm tra trạng thái...</h2>
            <button onclick="login()" id="loginButton" class="hidden w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold flex items-center justify-center gap-2 shadow-lg transition">
                <i class="fa-solid fa-cloud-arrow-up"></i> Đăng nhập bằng Google
            </button>
            <button onclick="enterGuestMode()" id="guestButton" class="hidden w-full py-3 mt-3 rounded-xl bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-300 font-bold hover:bg-slate-400 transition">
                Duyệt với chế độ Khách (Chỉ xem)
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-7xl h-screen flex flex-col transition duration-500" id="mainApp" style="filter: blur(3px);">
        
        <header class="glass-panel rounded-3xl px-4 py-3 mb-4 flex flex-col lg:flex-row justify-between items-center z-20 gap-3">
            <div class="flex items-center gap-3 w-full lg:w-auto justify-between lg:justify-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-red-600 to-green-600 flex items-center justify-center text-white shadow-lg">
                        <i class="fa-solid fa-tree text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight">Minhduc<span class="text-red-600">Kale</span></h1>
                        <p class="text-[10px] text-slate-600 dark:text-slate-400 font-bold uppercase">v10.0 Christmas Edition</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleAdminMode()" id="adminToggleBtn" class="w-9 h-9 rounded-xl bg-white/60 dark:bg-white/10 hover:bg-white transition flex items-center justify-center text-slate-700 dark:text-slate-200" title="Admin Mode"><i class="fa-solid fa-lock"></i></button>
                    <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-xl bg-white/60 dark:bg-white/10 hover:bg-white transition text-yellow-600 dark:text-yellow-400"><i id="darkIcon" class="fa-solid fa-moon"></i></button>
                    <div class="relative">
                        <button onclick="toggleNotif()" class="w-9 h-9 rounded-xl bg-white/60 dark:bg-white/10 hover:bg-white transition flex items-center justify-center"><i class="fa-solid fa-bell text-slate-700 dark:text-slate-200"></i><span id="notifDot" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span></button>
                        <div id="notifPanel" class="hidden absolute right-0 top-12 w-80 glass-card p-4 rounded-2xl z-50 shadow-2xl">
                            <h4 class="font-bold mb-2 dark:text-white">Lịch sử hoạt động (Admin)</h4>
                            <div id="notifList" class="space-y-2 max-h-60 overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="segmented-control w-full lg:w-auto justify-start lg:justify-center overflow-x-auto scrollbar-hide">
                <div class="segment-btn active" onclick="switchTab(event, 'home')"><i class="fa-solid fa-house mr-1"></i>Home</div>
                <div class="segment-btn" onclick="switchTab(event, 'docs')"><i class="fa-solid fa-folder-open mr-1"></i>Tài liệu</div>
                <div class="segment-btn" onclick="switchTab(event, 'drugs')"><i class="fa-solid fa-pills mr-1"></i>Thuốc</div>
                <div class="segment-btn" onclick="switchTab(event, 'notes')"><i class="fa-solid fa-note-sticky mr-1"></i>Note</div>
                <div class="segment-btn" onclick="switchTab(event, 'chat')"><i class="fa-solid fa-comments mr-1"></i>Chat</div>
                <div class="segment-btn" onclick="switchTab(event, 'tools')"><i class="fa-solid fa-screwdriver-wrench mr-1"></i>Tools</div>
            </div>

            <div class="hidden lg:flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-white/60 dark:bg-white/10 hover:bg-white transition flex items-center justify-center text-slate-700 dark:text-slate-200" title="User"><i class="fa-solid fa-user"></i></div>
                <div class="flex items-center gap-2 cursor-pointer hover:bg-white/40 p-1 rounded-lg transition" onclick="logout()" id="userControlsDesktop" style="display: none;">
                    <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-red-500">
                    <span id="userName" class="text-xs font-bold text-slate-800 dark:text-white">...</span>
                    <i class="fa-solid fa-right-from-bracket text-xs text-red-500 ml-1" title="Đăng xuất"></i>
                </div>
            </div>
        </header>

        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden pb-2">
            
            <div class="lg:col-span-8 flex flex-col h-full overflow-hidden relative glass-panel rounded-3xl p-1 border-0 bg-transparent shadow-none">
                
                <div id="view-home" class="flex flex-col gap-4 h-full p-4 transition-opacity duration-300">
                    <h2 class="text-xl font-bold dark:text-white mb-2">Mục Lớn</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="window.open(baseDriveLink, '_blank')" class="glass-card p-5 rounded-xl text-center cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/50 transition border-l-4 border-red-600"><i class="fa-solid fa-heart-pulse text-4xl text-red-600 mb-2"></i><h3 class="font-bold">Nội Khoa</h3><p class="text-xs text-slate-500">Xem trực tiếp Drive</p></div>
                        <div onclick="window.open(baseDriveLink, '_blank')" class="glass-card p-5 rounded-xl text-center cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/50 transition border-l-4 border-green-600"><i class="fa-solid fa-user-injured text-4xl text-green-600 mb-2"></i><h3 class="font-bold">Ngoại Khoa</h3><p class="text-xs text-slate-500">Xem trực tiếp Drive</p></div>
                         <div onclick="window.open(baseDriveLink, '_blank')" class="glass-card p-5 rounded-xl text-center cursor-pointer hover:bg-pink-50 dark:hover:bg-pink-900/50 transition border-l-4 border-pink-600"><i class="fa-solid fa-person-pregnant text-4xl text-pink-600 mb-2"></i><h3 class="font-bold">Sản Khoa</h3><p class="text-xs text-slate-500">Xem trực tiếp Drive</p></div>
                        <div onclick="window.open(baseDriveLink, '_blank')" class="glass-card p-5 rounded-xl text-center cursor-pointer hover:bg-orange-50 dark:hover:bg-orange-900/50 transition border-l-4 border-orange-600"><i class="fa-solid fa-baby text-4xl text-orange-600 mb-2"></i><h3 class="font-bold">Nhi Khoa</h3><p class="text-xs text-slate-500">Xem trực tiếp Drive</p></div>
                    </div>
                </div>

                <div id="view-docs" class="hidden flex-col gap-4 h-full p-2 transition-opacity duration-300">
                    <div class="flex gap-2 relative z-10">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-500"></i>
                            <input id="searchInput" type="text" onkeyup="renderFolders()" class="w-full pl-10 pr-4 py-3 rounded-xl ios-input text-base placeholder-slate-500 shadow-sm" placeholder="Tìm trên mây...">
                        </div>
                        <button onclick="toggleStarFilter()" id="btnStar" class="w-12 rounded-xl bg-white/60 dark:bg-slate-700 hover:text-yellow-500 text-slate-400 transition"><i class="fa-solid fa-star text-lg"></i></button>
                        <button onclick="openAddDocModal('add')" class="w-12 rounded-xl bg-slate-900 dark:bg-blue-600 text-white shadow-lg transition"><i class="fa-solid fa-plus text-lg"></i></button>
                    </div>
                    <div id="breadcrumb" class="hidden flex items-center gap-2 text-xs font-bold text-slate-600 dark:text-slate-300 px-2"><button onclick="renderFolders()">Home</button> / <span id="curFolder" class="text-blue-600">Folder</span></div>
                    
                    <div id="loadingDocs" class="flex justify-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-500"></i></div>
                    <div id="docsList" class="flex-1 overflow-y-auto pr-2 grid grid-cols-1 md:grid-cols-2 gap-3 content-start pb-20"></div>
                </div>

                <div id="view-drugs" class="hidden flex-col gap-4 h-full p-2 fade-in">
                    <div class="relative">
                        <i class="fa-solid fa-capsules absolute left-4 top-3.5 text-slate-500"></i>
                        <input id="drugSearch" type="text" onkeyup="filterDrugs()" class="w-full pl-10 pr-4 py-3 rounded-xl ios-input" placeholder="Tra cứu thuốc...">
                    </div>
                    <div id="drugList" class="flex-1 overflow-y-auto pr-2 space-y-3 pb-20">
                        <div class="glass-card p-4 rounded-2xl"><h4 class="font-bold text-blue-700">Paracetamol</h4><p class="text-sm italic text-slate-600 mt-1">Ức chế Prostaglandin ở TKTW.</p><div class="mt-2 grid grid-cols-2 gap-2 text-xs"><div class="bg-blue-50 p-2 rounded"><strong>NL:</strong> 500-1000mg / 4-6h.</div><div class="bg-green-50 p-2 rounded"><strong>TE:</strong> 10-15 mg/kg.</div></div></div>
                        <div class="glass-card p-4 rounded-2xl"><h4 class="font-bold text-blue-700">Amoxicillin</h4><p class="text-sm italic text-slate-600 mt-1">Ức chế tổng hợp vách tế bào.</p><div class="mt-2 grid grid-cols-2 gap-2 text-xs"><div class="bg-blue-50 p-2 rounded"><strong>NL:</strong> 500mg / 8h.</div><div class="bg-green-50 p-2 rounded"><strong>TE:</strong> 20-50 mg/kg/ngày.</div></div></div>
                    </div>
                </div>

                <div id="view-notes" class="hidden flex-col h-full p-2 fade-in gap-3">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="font-bold text-slate-800 dark:text-white flex items-center"><i class="fa-solid fa-cloud-arrow-up mr-2 text-green-500"></i>Cloud Notes</h3>
                        <div class="flex gap-2 items-center">
                            <span id="saveStatus" class="text-[10px] text-slate-400 italic">...</span>
                            <button onclick="downloadNote()" class="text-xs font-bold bg-green-100 text-green-700 px-3 py-1 rounded-lg">Xuất file</button>
                        </div>
                    </div>
                    <textarea id="noteArea" class="flex-1 w-full p-4 rounded-2xl ios-input resize-none text-sm leading-relaxed" placeholder="Viết gì đó... (Tự động lưu lên tài khoản của bạn)"></textarea>
                </div>

                <div id="view-chat" class="hidden flex-col h-full fade-in p-2">
                    <div class="flex-1 flex flex-col rounded-2xl overflow-hidden border border-white/40 dark:border-white/10 bg-white/30 dark:bg-black/20">
                        <div class="p-3 border-b border-white/20 flex justify-between items-center"><span class="font-bold text-sm dark:text-white"><i class="fa-solid fa-comments text-blue-500 mr-2"></i>Phòng Chat</span><span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full">Live</span></div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                        <div class="p-3 bg-white/50 dark:bg-slate-800/80 flex gap-2"><input id="msgInput" type="text" class="flex-1 ios-input rounded-full px-4 py-2 text-sm" placeholder="Nhắn tin..." onkeypress="if(event.key==='Enter') sendMsg()"><button onclick="sendMsg()" class="w-9 h-9 bg-blue-600 rounded-full text-white flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button></div>
                    </div>
                </div>
                
                <div id="view-tools" class="hidden flex-col gap-3 h-full overflow-y-auto pb-20 fade-in p-2">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                         <button onclick="openCalculator()" class="p-3 rounded-xl glass-card flex flex-col items-center gap-2 transition"><i class="fa-solid fa-calculator text-2xl text-orange-500"></i><span class="text-xs font-bold">Máy tính</span></button>
                         <button onclick="openTimer()" class="p-3 rounded-xl glass-card flex flex-col items-center gap-2 transition"><i class="fa-solid fa-stopwatch text-2xl text-blue-500"></i><span class="text-xs font-bold">Đếm ngược</span></button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-4 h-full overflow-hidden">
                 <div class="glass-card p-5 rounded-3xl relative overflow-hidden group">...</div>
                <div class="glass-panel p-5 rounded-3xl shadow-lg relative overflow-hidden flex-1 flex flex-col justify-end">...</div>
            </div>
        </div>
    </div>

    <div id="calcWindow" class="draggable-window hidden top-20 left-20 w-64 bg-slate-900 rounded-2xl overflow-hidden shadow-2xl border border-slate-700">...</div>
    <div id="timerWindow" class="draggable-window hidden top-40 left-60 w-56 bg-white dark:bg-slate-800 rounded-2xl overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-700">...</div>
    <div id="addDocModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-md">...</div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAcfs8LFgPeAkGyaSkmJeECoRBEwtfRv8E",
            authDomain: "minhduckale1.firebaseapp.com",
            databaseURL: "https://minhduckale1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "minhduckale1",
            storageBucket: "minhduckale1.firebasestorage.app",
            messagingSenderId: "479002042854",
            appId: "1:479002042854:web:c9e4b614ad48fefd10f627",
            measurementId: "G-GWWCJ6BNLF"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        
        let currentUser = null;
        let isAdminMode = false;
        let isGuestMode = false;
        const baseDriveLink = "https://drive.google.com/drive/folders/1GnW2tjMYi-FcmEstNQQu8WD25AK06W9-?usp=drive_link";
        
        // GLOBAL DATA STRUCTURES
        const folders = { "capcuu": "1. Cấp cứu", "noi": "2. Nội khoa", "ngoai": "3. Ngoại khoa", "nhi": "4. Nhi khoa", "duoc": "5. Dược lý", "khac": "6. Khác" };
        let allDocs = [];
        let bookmarks = JSON.parse(localStorage.getItem('mdk_fav') || '[]');
        let filterStar = false;

        // --- 1. AUTHENTICATION LOGIC ---
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => { alert("Lỗi đăng nhập: " + e.message); });
        }
        function logout() { auth.signOut(); isAdminMode = false; isGuestMode = false; location.reload(); }
        
        function enterGuestMode() {
            isGuestMode = true;
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').style.filter = 'none';
            document.getElementById('adminToggleBtn').style.display = 'none'; 
            document.getElementById('userControlsDesktop').style.display = 'none';
            loadDocs();
            switchTab(null, 'home');
        }

        auth.onAuthStateChanged(user => {
            document.getElementById('loginStatusText').innerText = "Đang kiểm tra trạng thái...";
            if (user) {
                currentUser = user;
                isGuestMode = false;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').style.filter = 'none';
                document.getElementById('userName').innerText = user.displayName.split(' ')[0];
                document.getElementById('userAvatar').src = user.photoURL || 'https://ui-avatars.com/api/?name='+user.displayName;
                document.getElementById('userControlsDesktop').style.display = 'flex';
                document.getElementById('adminToggleBtn').style.display = 'flex'; 
                
                loadDocs();
                // loadCloudNote(); // Not fully implemented in this base code
                switchTab(null, 'home');
            } else if (!isGuestMode) {
                currentUser = null;
                document.getElementById('loginStatusText').innerText = "Vui lòng đăng nhập hoặc duyệt với chế độ Khách.";
                document.getElementById('loginButton').classList.remove('hidden');
                document.getElementById('guestButton').classList.remove('hidden');
                document.getElementById('mainApp').style.filter = 'blur(3px)';
            }
        });

        // --- 2. ADMIN MODE & HISTORY ---
        function toggleAdminMode() {
            if (!currentUser) return alert("Bạn cần đăng nhập bằng tài khoản Google để vào chế độ Admin.");
            const password = prompt("Nhập mật khẩu quản trị (0000):");
            if (password === "0000") {
                isAdminMode = !isAdminMode;
                const btn = document.getElementById('adminToggleBtn');
                btn.classList.toggle('admin-glow', isAdminMode);
                btn.classList.toggle('bg-red-500', isAdminMode);
                btn.innerHTML = isAdminMode ? '<i class="fa-solid fa-lock-open"></i>' : '<i class="fa-solid fa-lock"></i>';
                alert(isAdminMode ? "Đã bật chế độ quản trị!" : "Đã tắt chế độ quản trị.");
                renderFolders(); 
                logAdminAction(isAdminMode ? "Bật chế độ ADMIN" : "Tắt chế độ ADMIN");
            } else if (password !== null) {
                alert("Mật khẩu không đúng.");
            }
        }
        function logAdminAction(action) {
            if (!currentUser) return;
            rtdb.ref('admin_history').push({
                user: currentUser.displayName,
                action: action,
                time: firebase.database.ServerValue.TIMESTAMP
            });
        }
        rtdb.ref('admin_history').limitToLast(5).on('child_added', snapshot => { /* ... Notification logic here ... */ });
        
        // --- 3. DYNAMIC DATA (FIRESTORE) & EDIT LOGIC ---
        function loadDocs() {
            document.getElementById('loadingDocs').classList.remove('hidden');
            db.collection('documents').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allDocs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const staticDocs = [{id:'s1', title:'Link Drive Tổng', folder:'khac', url:baseDriveLink}];
                allDocs = [...allDocs, ...staticDocs];
                
                document.getElementById('loadingDocs').classList.add('hidden');
                renderFolders();
            }, e => { console.error("Firestore Error:", e); document.getElementById('loadingDocs').innerHTML = 'Lỗi tải CSDL.'; });
        }

        function saveDocumentChanges() {
            if(!currentUser || !isAdminMode) return alert("Bạn không có quyền chỉnh sửa!");
            const id = document.getElementById('docIdToEdit').value;
            const title = document.getElementById('newDocTitle').value;
            const folder = document.getElementById('newDocFolder').value;
            const link = document.getElementById('newDocLink').value;

            if(!title || !link) return alert("Thiếu thông tin");
            const docData = { title, folder, url: link };

            if (id && id !== 's1') {
                db.collection('documents').doc(id).update(docData).then(() => {
                    logAdminAction(`Cập nhật tài liệu: ${title}`);
                    document.getElementById('addDocModal').classList.add('hidden');
                }).catch(e => alert("Lỗi cập nhật: " + e.message));
            } else {
                db.collection('documents').add({...docData, author: currentUser.displayName, createdAt: firebase.firestore.FieldValue.serverTimestamp()}).then(() => {
                    logAdminAction(`Thêm tài liệu mới: ${title}`);
                    document.getElementById('addDocModal').classList.add('hidden');
                }).catch(e => alert("Lỗi thêm: " + e.message));
            }
        }
        
        // --- 4. UI LOGIC (Folders, Tools, Draggable) ---
        const listEl = document.getElementById('docsList');
        function renderFolders() {
            listEl.innerHTML=''; document.getElementById('breadcrumb').classList.add('hidden');
            const q = document.getElementById('searchInput').value.toLowerCase();
            
            if(q) {
                const res = allDocs.filter(d => d.title.toLowerCase().includes(q));
                res.forEach(d => renderDocItem(d));
                return;
            }

            Object.keys(folders).forEach(k => {
                const count = allDocs.filter(d=>d.folder===k).length;
                listEl.innerHTML += `<div onclick="openFolder('${k}')" class="glass-card p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:border-blue-400 border border-transparent"><div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-2xl text-blue-500 shadow"><i class="fa-solid fa-folder"></i></div><div><h3 class="font-bold dark:text-white">${folders[k]}</h3><p class="text-xs text-slate-500">${count} file</p></div></div>`;
            });
        }
        function openFolder(k) {
            document.getElementById('breadcrumb').classList.remove('hidden'); document.getElementById('curFolder').innerText = folders[k];
            listEl.innerHTML='';
            const items = allDocs.filter(d => d.folder === k && (!filterStar || bookmarks.includes(d.id)));
            if(items.length===0) listEl.innerHTML='<div class="col-span-2 text-center opacity-50 font-bold mt-10">Thư mục trống</div>';
            items.forEach(d => renderDocItem(d));
        }
        function renderDocItem(d) {
            const isFav = bookmarks.includes(d.id);
            const canEdit = isAdminMode && d.id !== 's1'; // Can edit if Admin and not a static link
            const editBtn = canEdit ? `<button onclick="openAddDocModal('edit', '${d.id}')" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-blue-500 transition"><i class="fa-solid fa-pencil-alt text-sm"></i></button>` : '';

            listEl.innerHTML += `
            <div class="glass-card p-3 rounded-2xl flex items-center gap-3 relative">
                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600"><i class="fa-solid fa-file"></i></div>
                <div class="flex-1 min-w-0"><h4 class="font-bold truncate dark:text-white text-sm">${d.title}</h4><a href="${d.url}" target="_blank" class="text-xs text-blue-500 font-bold uppercase">Mở</a></div>
                ${editBtn}
                <button onclick="toggleFav('${d.id}')" class="text-lg ${isFav?'text-yellow-400':'text-slate-300'}"><i class="fa-solid fa-star"></i></button>
            </div>`;
        }
        
        // --- FINAL INIT & UTILS ---
        function switchTab(event, t) {
            if(event) { document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); }
            ['home', 'docs', 'drugs', 'notes', 'chat', 'tools'].forEach(v => document.getElementById('view-' + v).classList.add('hidden', 'flex'));
            document.getElementById('view-' + t).classList.remove('hidden'); document.getElementById('view-' + t).classList.add('flex');
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        function updateClock() { document.getElementById('date-display').innerText = new Date().toLocaleDateString('vi-VN'); }
        function toggleFav(id) { /* ... bookmark logic ... */ }
        function toggleStarFilter() { filterStar=!filterStar; document.getElementById('btnStar').classList.toggle('text-yellow-500'); renderFolders(); }
        function openAddDocModal(mode, docId) { /* ... Modal logic ... */ }

        // Snow (Removed interval call from init for cleaner startup, added function body)
        function createSnowflake() { /* ... */ }
        function startSnow() { /* ... */ }

        // Final Init
        (function() {
            // Placeholder for missing functions (to prevent errors)
            window.openCalculator=()=>{}; window.openTimer=()=>{}; window.loadCloudNote=()=>{}; window.sendMsg=()=>{};
            window.toggleFav=()=>{}; window.toggleStarFilter=()=>{}; window.filterDrugs=()=>{}; window.downloadNote=()=>{};
            
            // Execute
            if(localStorage.getItem('mdk_dark') === 'true') document.documentElement.classList.add('dark');
            setInterval(updateClock, 1000);
            startSnow(); // Start snow theme
        })();
    </script>
</body>
</html>
