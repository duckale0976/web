<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinhducKale - Professional Hub v8.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 
                        'blob': 'blob 10s infinite',
                        'spin-slow': 'spin 10s linear infinite', 
                    },
                    keyframes: {
                        blob: { '0%': { transform: 'translate(0,0) scale(1)' }, '33%': { transform: 'translate(30px,-50px) scale(1.1)' }, '66%': { transform: 'translate(-20px,20px) scale(0.9)' }, '100%': { transform: 'translate(0,0) scale(1)' } },
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE & THEME */
        body { transition: background-color 0.5s, color 0.5s; background-color: #e0f2fe; color: #1e293b; }
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        
        /* BACKGROUND BLOBS */
        .bg-blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.8; z-index: -1; animation: blob 15s infinite alternate; pointer-events: none; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #93c5fd; }
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #6ee7b7; }
        .dark .blob-1 { background: #1e40af; opacity: 0.3; }
        .dark .blob-2 { background: #065f46; opacity: 0.3; }

        /* GLASS MORPHISM */
        .glass-panel { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(255, 255, 255, 0.08); } 
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.3s ease; }
        .dark .glass-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.05); } 
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* INPUTS & CONTROLS */
        .ios-input { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(203, 213, 225, 0.8); color: #0f172a; font-weight: 600; }
        .dark .ios-input { background: rgba(0, 0, 0, 0.4); border-color: rgba(255,255,255,0.15); color: white; }
        .ios-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); border-color: #3b82f6; }
        
        .segment-btn { padding: 6px 20px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; color: #64748b; }
        .dark .segment-btn { color: #94a3b8; }
        .segment-btn.active { background: white; color: #0f172a; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .segment-btn.active { background: #334155; color: white; }

        /* MUSIC PLAYER PRO */
        .music-disc { transition: transform 0.5s; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .music-disc.playing { animation: spin 10s linear infinite; box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        .music-disc.paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        input[type=range].music-progress {
            -webkit-appearance: none; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;
        }
        .dark input[type=range].music-progress { background: #334155; }
        input[type=range].music-progress::-webkit-slider-thumb {
            -webkit-appearance: none; width: 0; height: 0; box-shadow: -400px 0 0 400px #3b82f6;
        }

        /* UTILS */
        .tool-content { max-height: 0; overflow: hidden; transition: all 0.3s ease-out; opacity: 0; }
        .tool-content.open { max-height: 500px; opacity: 1; margin-top: 0.5rem; }
        .notification-dot { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 1px solid white; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden selection:bg-blue-500 selection:text-white">

    <div class="bg-blob blob-1"></div><div class="bg-blob blob-2"></div>

    <div class="container mx-auto px-4 py-4 max-w-7xl min-h-screen flex flex-col">
        
        <header class="glass-panel rounded-2xl px-5 py-3 mb-6 flex flex-wrap md:flex-nowrap justify-between items-center z-20 sticky top-2 gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center shadow-lg"><i class="fa-solid fa-staff-snake text-lg"></i></div>
                <div>
                    <h1 class="text-lg font-extrabold text-slate-900 dark:text-white leading-none">Minhduc<span class="text-blue-600">Kale</span></h1>
                    <div id="authStatus" class="text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-blue-600 transition">Guest Mode</div>
                </div>
            </div>
            
            <div class="glass-card rounded-lg p-1 flex order-3 md:order-2 w-full md:w-auto justify-center">
                <div class="segment-btn active" onclick="UI.switchTab('docs')" id="btn-docs">Tài liệu</div>
                <div class="segment-btn" onclick="UI.switchTab('fav')" id="btn-fav">Đã lưu</div>
                <div class="segment-btn" onclick="UI.switchTab('tools')" id="btn-tools">Công cụ</div>
            </div>

            <div class="flex items-center gap-3 order-2 md:order-3 ml-auto md:ml-0">
                <div class="hidden lg:block text-right mr-2"><span id="clock" class="block text-sm font-mono font-bold text-slate-800 dark:text-white">00:00</span></div>
                <button aria-label="Dark Mode" onclick="UI.toggleDark()" class="w-9 h-9 rounded-lg bg-white/50 dark:bg-white/10 hover:bg-white flex items-center justify-center text-slate-700 dark:text-yellow-400 transition"><i id="darkIcon" class="fa-solid fa-moon"></i></button>
                <div id="authBtnContainer">
                    <button id="loginBtn" onclick="Auth.login()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold shadow-md transition">Đăng nhập</button>
                    <button id="logoutBtn" onclick="Auth.logout()" class="hidden w-9 h-9 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-500 hover:bg-red-200 flex items-center justify-center transition"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 pb-10">
            
            <div class="lg:col-span-8 flex flex-col min-h-[500px]">
                
                <div id="view-docs" class="flex flex-col gap-5 fade-in">
                    <div id="recentSection" class="hidden">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Vừa xem gần đây</h4>
                        <div id="recentList" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide"></div>
                    </div>

                    <div class="flex gap-2 relative z-10">
                        <div class="relative flex-1 group">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-slate-400 group-focus-within:text-blue-500 transition"></i>
                            <input id="searchInput" type="text" class="w-full pl-10 pr-4 py-3 rounded-xl ios-input text-sm shadow-sm transition" placeholder="Tìm kiếm nhanh (gõ không dấu)...">
                        </div>
                        <button onclick="UI.openModal()" class="px-4 bg-slate-900 dark:bg-blue-600 text-white rounded-xl shadow-lg hover:scale-105 active:scale-95 transition"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <div id="breadcrumb" class="hidden flex items-center gap-2 text-xs font-bold text-slate-600 dark:text-slate-300 bg-white/40 px-3 py-1.5 rounded-lg w-fit">
                        <button onclick="Data.renderFolders()" class="hover:text-blue-600"><i class="fa-solid fa-house"></i></button> <span>/</span> <span id="currentFolderTitle" class="text-blue-600 dark:text-blue-400">Folder</span>
                    </div>

                    <div id="loadingIndicator" class="hidden text-center py-10"><div class="loader mx-auto"></div><p class="mt-2 text-xs font-bold text-slate-500">Đang tải...</p></div>
                    <div id="docsList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div id="view-fav" class="hidden flex-col gap-5 fade-in">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-star text-yellow-500"></i> Đã lưu trữ</h3>
                    <div id="favList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div id="view-tools" class="hidden flex-col gap-5 fade-in">
                    <div class="glass-card rounded-2xl overflow-hidden border-l-4 border-green-500 p-4">
                        <h4 class="font-bold text-slate-800 dark:text-white mb-2"><i class="fa-solid fa-database text-green-600 mr-2"></i>Dữ liệu & Đồng bộ</h4>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800 text-center mb-3">
                            <p class="text-xs text-blue-700 dark:text-blue-300 font-bold mb-2">⚡ Đồng bộ nhanh từ Apps Script</p>
                            <button onclick="Data.pasteFromClipboard()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg shadow transition flex items-center justify-center gap-2"><i class="fa-regular fa-clipboard"></i> Dán từ Clipboard</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="Data.exportExcel()" class="flex-1 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50"><i class="fa-solid fa-download mr-1"></i> Xuất Excel</button>
                            <button onclick="document.getElementById('fileIn').click()" class="flex-1 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50"><i class="fa-solid fa-upload mr-1"></i> Nạp JSON</button>
                            <input type="file" id="fileIn" hidden accept=".json" onchange="Data.importFile(this)">
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-4">
                        <h4 class="font-bold text-slate-800 dark:text-white mb-3">Máy tính Y khoa</h4>
                        <div class="flex gap-2 mb-3">
                            <button onclick="UI.toggleTool('bmi')" class="flex-1 py-1.5 bg-indigo-50 text-indigo-700 font-bold text-xs rounded border border-indigo-100 hover:bg-indigo-100">BMI</button>
                            <button onclick="UI.toggleTool('map')" class="flex-1 py-1.5 bg-red-50 text-red-700 font-bold text-xs rounded border border-red-100 hover:bg-red-100">MAP</button>
                            <button onclick="UI.toggleTool('egfr')" class="flex-1 py-1.5 bg-orange-50 text-orange-700 font-bold text-xs rounded border border-orange-100 hover:bg-orange-100">eGFR</button>
                        </div>
                        <div id="tool-bmi" class="tool-content hidden"><div class="flex gap-2 items-center"><input id="bmi-w" placeholder="Kg" class="ios-input w-16 p-1 rounded text-center"><input id="bmi-h" placeholder="Cm" class="ios-input w-16 p-1 rounded text-center"><button onclick="Tools.calcBMI()" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold">Tính</button><span id="bmi-res" class="font-bold text-indigo-600 ml-2"></span></div></div>
                        <div id="tool-map" class="tool-content hidden"><div class="flex gap-2 items-center"><input id="map-s" placeholder="Sys" class="ios-input w-16 p-1 rounded text-center"><input id="map-d" placeholder="Dia" class="ios-input w-16 p-1 rounded text-center"><button onclick="Tools.calcMAP()" class="px-3 py-1 bg-red-600 text-white rounded text-xs font-bold">Tính</button><span id="map-res" class="font-bold text-red-600 ml-2"></span></div></div>
                        <div id="tool-egfr" class="tool-content hidden"><div class="flex gap-2 items-center"><input id="egfr-a" placeholder="Tuổi" class="ios-input w-12 p-1 rounded text-center"><input id="egfr-w" placeholder="Kg" class="ios-input w-12 p-1 rounded text-center"><input id="egfr-c" placeholder="Cre" class="ios-input w-12 p-1 rounded text-center"><button onclick="Tools.calcEGFR()" class="px-3 py-1 bg-orange-600 text-white rounded text-xs font-bold">Tính</button><span id="egfr-res" class="font-bold text-orange-600 ml-2 text-xs"></span></div></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-5">
                
                <div class="glass-panel p-5 rounded-3xl shadow-xl relative overflow-hidden group">
                    <div class="flex flex-col items-center">
                        <div id="musicDisc" class="music-disc w-32 h-32 rounded-full bg-slate-900 border-4 border-slate-800 flex items-center justify-center overflow-hidden mb-4 relative">
                            <img src="https://img.icons8.com/color/96/vinyl-music.png" class="w-full h-full opacity-80 object-cover">
                            <div class="absolute w-8 h-8 bg-white/20 rounded-full backdrop-blur-sm border border-white/30"></div>
                        </div>
                        <div class="text-center w-full mb-3">
                            <h3 id="musicTitle" class="text-sm font-bold text-slate-800 dark:text-white truncate">Lofi Focus</h3>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">MinhducKale Radio</p>
                        </div>
                        <div class="w-full flex items-center gap-2 mb-4">
                            <span id="currTime" class="text-[10px] font-mono text-slate-500">00:00</span>
                            <input type="range" id="musicProgress" class="music-progress flex-1 cursor-pointer" value="0" min="0" max="100">
                            <span id="durTime" class="text-[10px] font-mono text-slate-500">00:00</span>
                        </div>
                        <div class="flex items-center gap-6">
                            <button onclick="Music.prev()" class="text-slate-400 hover:text-slate-800 dark:hover:text-white transition"><i class="fa-solid fa-backward-step text-lg"></i></button>
                            <button onclick="Music.toggle()" id="playBtn" class="w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg hover:scale-105 active:scale-95 transition flex items-center justify-center"><i class="fa-solid fa-play text-lg ml-1"></i></button>
                            <button onclick="Music.next()" class="text-slate-400 hover:text-slate-800 dark:hover:text-white transition"><i class="fa-solid fa-forward-step text-lg"></i></button>
                        </div>
                    </div>
                    <audio id="bgAudio" class="hidden"></audio>
                </div>

                <div class="glass-card p-4 rounded-3xl flex flex-col border border-blue-200 dark:border-blue-900/30 max-h-[250px]">
                    <h3 class="font-bold text-slate-800 dark:text-white text-sm mb-2 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-500"></i> Việc cần làm</h3>
                    <div class="flex gap-2 mb-2"><input id="todoInput" type="text" class="flex-1 ios-input p-1.5 rounded-lg text-xs" placeholder="Thêm việc..." onkeypress="if(event.key==='Enter') App.addTodo()"><button onclick="App.addTodo()" class="w-7 h-7 bg-blue-600 text-white rounded-lg flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button></div>
                    <div id="todoList" class="overflow-y-auto pr-1 flex-1 space-y-1"></div>
                </div>

                <div class="glass-card p-4 rounded-3xl border border-yellow-200 dark:border-yellow-900/30">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800 dark:text-white text-sm"><i class="fa-solid fa-note-sticky text-yellow-500 mr-1"></i> Ghi chú</h3><span id="noteStatus" class="text-[9px] text-green-600 font-bold opacity-0 transition">ĐÃ LƯU</span></div>
                    <textarea id="quickNote" oninput="App.saveNote()" class="w-full bg-white/50 dark:bg-slate-900/50 rounded-xl p-2 ios-input text-xs leading-relaxed shadow-inner h-24 resize-none focus:ring-1 ring-yellow-400" placeholder="..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-[90%] md:w-[400px] p-6 rounded-3xl shadow-2xl animate-float">
            <h3 class="text-lg font-extrabold text-slate-900 dark:text-white mb-4">Thêm Tài Liệu</h3>
            <div class="space-y-3">
                <input id="mTitle" class="w-full ios-input p-2.5 rounded-xl text-sm" placeholder="Tên tài liệu">
                <select id="mFolder" class="w-full ios-input p-2.5 rounded-xl text-sm font-bold text-slate-600"></select>
                <input id="mLink" class="w-full ios-input p-2.5 rounded-xl text-sm" placeholder="Link Drive/Web">
                <div class="flex gap-2 pt-2"><button onclick="UI.closeModal()" class="flex-1 py-2.5 rounded-xl bg-slate-100 text-slate-500 font-bold text-xs hover:bg-slate-200">Hủy</button><button onclick="Data.addDoc()" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold text-xs hover:bg-blue-700 shadow-lg">Lưu ngay</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, update, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAcfs8LFgPeAkGyaSkmJeECoRBEwtfRv8E", authDomain: "minhduckale1.firebaseapp.com", databaseURL: "https://minhduckale1-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "minhduckale1", storageBucket: "minhduckale1.firebasestorage.app", messagingSenderId: "479002042854", appId: "1:479002042854:web:c9e4b614ad48fefd10f627", measurementId: "G-GWWCJ6BNLF" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // STATE
        const State = { user: null, docs: [], favs: [], recent: [], todos: [], listeners: [] };
        const Folders = { "capcuu":{n:"Cấp cứu",i:"fa-truck-medical",c:"text-red-500",l:[]},"noikhoa":{n:"Nội khoa",i:"fa-user-doctor",c:"text-blue-500",l:[]},"ngoaikhoa":{n:"Ngoại khoa",i:"fa-scalpel",c:"text-green-600",l:[]},"san":{n:"Sản phụ",i:"fa-person-pregnant",c:"text-pink-500",l:[]},"nhi":{n:"Nhi khoa",i:"fa-baby",c:"text-orange-500",l:[]},"canlamsang":{n:"Cận lâm sàng",i:"fa-microscope",c:"text-purple-500",l:[]},"khac":{n:"Khác",i:"fa-folder-open",c:"text-slate-500",l:[]} };

        // --- AUTH ---
        const Auth = {
            login: () => signInWithPopup(auth, provider).catch(e => alert(e.message)),
            logout: () => { State.listeners.forEach(r => off(r)); State.listeners = []; signOut(auth); },
            init: () => {
                onAuthStateChanged(auth, user => {
                    State.user = user;
                    const els = { login: document.getElementById('loginBtn'), logout: document.getElementById('logoutBtn'), profile: document.getElementById('userProfile'), status: document.getElementById('authStatus') };
                    if (user) {
                        els.login.classList.add('hidden'); els.logout.classList.remove('hidden'); els.profile.classList.remove('hidden'); els.profile.classList.add('flex');
                        document.getElementById('userAvatar').src = user.photoURL; document.getElementById('userName').innerText = user.displayName; els.status.innerText = "Đã đồng bộ"; els.status.classList.add('text-green-500');
                        Data.sync(user.uid);
                    } else {
                        els.login.classList.remove('hidden'); els.logout.classList.add('hidden'); els.profile.classList.add('hidden'); els.status.innerText = "Guest Mode"; els.status.classList.remove('text-green-500');
                        Data.loadLocal();
                    }
                });
            }
        };

        // --- DATA ---
        const Data = {
            loadLocal: () => {
                State.docs = JSON.parse(localStorage.getItem('docs') || '[]'); State.favs = JSON.parse(localStorage.getItem('favs') || '[]');
                State.recent = JSON.parse(localStorage.getItem('recent') || '[]'); State.todos = JSON.parse(localStorage.getItem('todos') || '[]');
                UI.renderAll();
            },
            sync: (uid) => {
                const listen = (path, cb) => { const r = ref(db, path); onValue(r, cb); State.listeners.push(r); };
                document.getElementById('loadingIndicator').classList.remove('hidden');
                listen(`users/${uid}/docs`, s => { const v = s.val(); State.docs = v ? (Array.isArray(v)?v:Object.values(v)) : []; UI.renderDocs(); document.getElementById('loadingIndicator').classList.add('hidden'); });
                listen(`users/${uid}/favs`, s => { State.favs = s.val() || []; UI.renderFavs(); UI.renderDocs(); });
                listen(`users/${uid}/recent`, s => { State.recent = s.val() || []; UI.renderRecent(); });
                listen(`users/${uid}/todos`, s => { State.todos = s.val() ? Object.values(s.val()) : []; UI.renderTodos(); });
                listen(`users/${uid}/note`, s => document.getElementById('quickNote').value = s.val() || "");
            },
            save: (key, val) => {
                if (State.user) set(ref(db, `users/${State.user.uid}/${key}`), val);
                else { localStorage.setItem(key, JSON.stringify(val)); Data.loadLocal(); }
            },
            addDoc: () => {
                const t = document.getElementById('mTitle').value, f = document.getElementById('mFolder').value, l = document.getElementById('mLink').value;
                if (!t || !l) return alert("Thiếu thông tin");
                const newDocs = [...State.docs, { id: 'u'+Date.now(), title: t, folder: f, url: l }];
                Data.save('docs', newDocs); UI.closeModal();
            },
            pasteFromClipboard: async () => {
                try {
                    const txt = await navigator.clipboard.readText(); const start = txt.indexOf('['), end = txt.lastIndexOf(']');
                    if (start === -1) throw new Error();
                    const json = JSON.parse(txt.substring(start, end + 1));
                    if (confirm(`Tìm thấy ${json.length} file. Đồng bộ ngay?`)) Data.save('docs', json);
                } catch { prompt("Lỗi đọc. Dán thủ công JSON vào đây:", "") && Data.save('docs', JSON.parse(prompt)); }
            },
            exportExcel: () => {
                if (!State.docs.length) return alert("Trống");
                const ws = XLSX.utils.json_to_sheet(State.docs); const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "MinhducKale_Data.xlsx");
            },
            importFile: (input) => {
                const f = input.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(Array.isArray(d) && confirm(`Nạp ${d.length} file?`)) Data.save('docs', d); } catch{alert("Lỗi file");} };
                r.readAsText(f); input.value = '';
            }
        };

        // --- UI ---
        const UI = {
            toggleDark: () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('dark', document.documentElement.classList.contains('dark')); },
            switchTab: (t) => {
                document.querySelectorAll('.segment-btn').forEach(b => b.classList.toggle('active', b.id === 'btn-'+t));
                ['docs','fav','tools'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('view-'+t).classList.remove('hidden');
                if(t==='docs') document.getElementById('view-docs').classList.add('flex');
                if(t==='fav') { document.getElementById('view-fav').classList.add('flex'); UI.renderFavs(); }
                if(t==='tools') document.getElementById('view-tools').classList.add('flex');
            },
            toggleTool: (id) => { const el = document.getElementById('tool-'+id); const isH = el.classList.contains('hidden'); document.querySelectorAll('.tool-content').forEach(e=>e.classList.add('hidden','opacity-0')); if(isH) { el.classList.remove('hidden'); setTimeout(()=>el.classList.remove('opacity-0'),10); } },
            openModal: () => document.getElementById('addModal').classList.remove('hidden'),
            closeModal: () => document.getElementById('addModal').classList.add('hidden'),
            
            renderAll: () => { UI.renderDocs(); UI.renderFavs(); UI.renderRecent(); UI.renderTodos(); },
            
            renderDocs: () => {
                const term = UI.vn(document.getElementById('searchInput').value);
                const list = document.getElementById('docsList'); list.innerHTML = '';
                document.getElementById('breadcrumb').classList.add('hidden');
                
                if (term) {
                    const res = State.docs.filter(d => UI.vn(d.title).includes(term));
                    if (!res.length) list.innerHTML = `<div class="col-span-2 text-center py-10 text-slate-400 text-sm">Không tìm thấy</div>`;
                    else res.forEach(d => list.appendChild(UI.createDocEl(d)));
                } else {
                    Object.keys(Folders).forEach(k => Folders[k].l = []);
                    State.docs.forEach(d => { if(Folders[d.folder]) Folders[d.folder].l.push(d); else Folders['khac'].l.push(d); });
                    Object.keys(Folders).forEach(k => {
                        const f = Folders[k];
                        const div = document.createElement('div');
                        div.className = "glass-card p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-white/90 dark:hover:bg-slate-700/80 transition border-l-4 border-transparent hover:border-blue-500";
                        div.innerHTML = `<div class="w-12 h-12 rounded-xl bg-white dark:bg-slate-800 flex items-center justify-center text-2xl ${f.c} shadow-sm"><i class="fa-solid ${f.i}"></i></div><div class="flex-1"><h3 class="font-bold text-slate-800 dark:text-white text-base">${f.n}</h3><p class="text-xs font-bold text-slate-500">${f.l.length} file</p></div><i class="fa-solid fa-chevron-right text-slate-300"></i>`;
                        div.onclick = () => UI.openFolder(k);
                        list.appendChild(div);
                    });
                }
            },
            openFolder: (k) => {
                const f = Folders[k]; const list = document.getElementById('docsList');
                document.getElementById('breadcrumb').classList.remove('hidden');
                document.getElementById('currentFolderTitle').innerText = f.n;
                list.innerHTML = '';
                if (!f.l.length) list.innerHTML = `<div class="col-span-2 text-center py-10 opacity-50 font-bold dark:text-white">Trống</div>`;
                f.l.forEach(d => list.appendChild(UI.createDocEl(d)));
            },
            createDocEl: (d) => {
                const isFav = State.favs.includes(d.id);
                const el = document.createElement('div');
                el.className = "glass-card p-3 rounded-2xl flex items-center gap-3 hover:border-blue-400 border border-white/50 transition shadow-sm group";
                el.innerHTML = `<div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center shrink-0"><i class="fa-solid fa-file-lines text-blue-500 text-sm"></i></div><div class="flex-1 min-w-0 cursor-pointer area-click"><h4 class="font-bold text-slate-800 dark:text-slate-100 text-sm truncate group-hover:text-blue-600 transition">${d.title}</h4></div><button class="p-2 hover:scale-110 transition btn-fav"><i class="fa-solid fa-star ${isFav?'text-yellow-400':'text-slate-200'}"></i></button>`;
                el.querySelector('.area-click').onclick = () => App.openDoc(d);
                el.querySelector('.btn-fav').onclick = (e) => { e.stopPropagation(); App.toggleFav(d.id); };
                return el;
            },
            renderFavs: () => {
                const c = document.getElementById('favList'); c.innerHTML = '';
                const l = State.docs.filter(d => State.favs.includes(d.id));
                if (!l.length) c.innerHTML = `<p class="text-slate-400 text-xs italic col-span-2 text-center">Chưa lưu tài liệu nào</p>`;
                else l.forEach(d => c.appendChild(UI.createDocEl(d)));
            },
            renderRecent: () => {
                const c = document.getElementById('recentList');
                if (!State.recent.length) { document.getElementById('recentSection').classList.add('hidden'); return; }
                document.getElementById('recentSection').classList.remove('hidden'); c.innerHTML = '';
                State.recent.forEach(d => {
                    const el = document.createElement('div');
                    el.className = "shrink-0 w-28 h-20 glass-card p-3 rounded-xl flex flex-col justify-between cursor-pointer hover:bg-blue-50 dark:hover:bg-slate-700 transition";
                    el.innerHTML = `<i class="fa-solid fa-clock-rotate-left text-blue-400 text-xs"></i><p class="text-[10px] font-bold text-slate-700 dark:text-slate-200 line-clamp-2 leading-tight">${d.title}</p>`;
                    el.onclick = () => App.openDoc(d);
                    c.appendChild(el);
                });
            },
            renderTodos: () => {
                const c = document.getElementById('todoList'); c.innerHTML = '';
                if (!State.todos.length) c.innerHTML = '<p class="text-center text-[10px] text-slate-400 mt-2">Trống</p>';
                State.todos.forEach(t => {
                    const el = document.createElement('div');
                    el.className = "flex items-center gap-2 group p-1.5 rounded hover:bg-white/40 dark:hover:bg-white/5 transition";
                    el.innerHTML = `<button class="btn-chk"><i class="fa-regular ${t.done?'fa-circle-check text-green-500':'fa-circle text-slate-300'} text-sm"></i></button><span class="flex-1 text-xs font-bold ${t.done?'line-through text-slate-400':'text-slate-700 dark:text-slate-200'}">${t.text}</span><button class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition btn-del"><i class="fa-solid fa-xmark text-xs"></i></button>`;
                    el.querySelector('.btn-chk').onclick = () => App.toggleTodo(t.id);
                    el.querySelector('.btn-del').onclick = () => App.delTodo(t.id);
                    c.appendChild(el);
                });
            },
            vn: (s) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d")
        };

        // --- APP LOGIC ---
        const App = {
            openDoc: (d) => {
                const r = State.recent.filter(x => x.id !== d.id); r.unshift(d);
                if (r.length > 10) r.pop(); Data.save('recent', r); window.open(d.url, '_blank', 'noopener,noreferrer');
            },
            toggleFav: (id) => {
                let f = State.favs; if(f.includes(id)) f=f.filter(x=>x!==id); else f.push(id);
                Data.save('favs', f);
            },
            addTodo: () => {
                const i = document.getElementById('todoInput'); const v = i.value.trim();
                if (!v) return;
                const t = { id: Date.now(), text: v, done: false };
                Data.save(`todos/${t.id}`, t); i.value = '';
            },
            toggleTodo: (id) => { const t = State.todos.find(x => x.id == id); if(t) Data.save(`todos/${id}/done`, !t.done); },
            delTodo: (id) => { if(State.user) remove(ref(db, `users/${State.user.uid}/todos/${id}`)); else { State.todos = State.todos.filter(x => x.id != id); Data.save('todos', State.todos); } },
            saveNote: () => {
                const v = document.getElementById('quickNote').value;
                if(State.user) set(ref(db, `users/${State.user.uid}/note`), v);
                const s = document.getElementById('noteStatus'); s.style.opacity = '1'; setTimeout(() => s.style.opacity = '0', 2000);
            }
        };

        // --- MUSIC ---
        const Music = {
            tracks: [{t:"Lofi Study", u:"https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3"},{t:"Piano Focus", u:"https://cdn.pixabay.com/download/audio/2022/03/10/audio_5b8220a28f.mp3"},{t:"Rainy Day", u:"https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3"}],
            idx: 0, el: document.getElementById('bgAudio'), disc: document.getElementById('musicDisc'),
            init: () => {
                const el = Music.el;
                el.ontimeupdate = () => {
                    const p = (el.currentTime / el.duration) * 100;
                    document.getElementById('musicProgress').value = p || 0;
                    document.getElementById('currTime').innerText = Music.fmt(el.currentTime);
                    document.getElementById('durTime').innerText = Music.fmt(el.duration || 0);
                };
                el.onended = () => Music.next();
                document.getElementById('musicProgress').oninput = (e) => el.currentTime = (e.target.value / 100) * el.duration;
                Music.load(0);
            },
            load: (i) => { Music.el.src = Music.tracks[i].u; document.getElementById('musicTitle').innerText = Music.tracks[i].t; },
            toggle: () => { 
                if(Music.el.paused) { Music.el.play(); document.getElementById('playBtnIcon').className="fa-solid fa-pause text-lg ml-0"; Music.disc.classList.add('playing'); Music.disc.classList.remove('paused'); } 
                else { Music.el.pause(); document.getElementById('playBtnIcon').className="fa-solid fa-play text-lg ml-1"; Music.disc.classList.add('paused'); }
            },
            next: () => { Music.idx = (Music.idx+1)%Music.tracks.length; Music.load(Music.idx); Music.toggle(); },
            prev: () => { Music.idx = (Music.idx-1+Music.tracks.length)%Music.tracks.length; Music.load(Music.idx); Music.toggle(); },
            fmt: (s) => { const m = Math.floor(s/60), sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
        };

        // --- TOOLS ---
        const Tools = {
            calcBMI: () => { const w = document.getElementById('bmi-w').value, h = document.getElementById('bmi-h').value/100; if(w&&h) document.getElementById('bmi-res').innerText = (w/(h*h)).toFixed(1); },
            calcMAP: () => { const s = Number(document.getElementById('map-s').value), d = Number(document.getElementById('map-d').value); if(s&&d) document.getElementById('map-res').innerText = ((2*d+s)/3).toFixed(0); },
            calcEGFR: () => { const a = document.getElementById('egfr-a').value, w = document.getElementById('egfr-w').value, c = document.getElementById('egfr-c').value; if(a&&w&&c) document.getElementById('egfr-res').innerText = (((140-a)*w)/(72*c)).toFixed(1); }
        };

        // EXPORT GLOBALS
        window.Auth = Auth; window.UI = UI; window.Data = Data; window.App = App; window.Music = Music; window.Tools = Tools;

        // INIT
        Auth.init();
        Music.init();
        if(localStorage.getItem('dark')==='true') document.documentElement.classList.add('dark');
        document.getElementById('searchInput').onkeyup = UI.renderDocs;
        const sel = document.getElementById('newDocFolder'); Object.keys(Folders).forEach(k => { const o = document.createElement('option'); o.value = k; o.text = Folders[k].n; sel.appendChild(o); });
        setInterval(() => { const n = new Date(); document.getElementById('clock').innerText = n.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); }, 1000);
    </script>
</body>
</html>
